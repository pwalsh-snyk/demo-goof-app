name: Snyk SBOM Reachability Test

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  snyk-oss:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Snyk CLI
        run: npm install -g snyk

      - name: Authenticate Snyk
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk auth "$SNYK_TOKEN"

      - name: Generate SBOM (CycloneDX JSON)
        run: snyk sbom --org=bb34b202-b76c-4e32-bba2-23b970d74f04 --format=cyclonedx1.5+json --all-projects > sbom.json

      - name: Test SBOM with reachability (experimental)
        run: |
          snyk sbom test --experimental --org=bb34b202-b76c-4e32-bba2-23b970d74f04 --file=sbom.json --reachability || EXIT_CODE=$?; \
          if [ "$EXIT_CODE" != "0" ] && [ "$EXIT_CODE" != "1" ]; then exit "$EXIT_CODE"; else echo "Snyk completed successfully (exit code: $EXIT_CODE)"; fi
