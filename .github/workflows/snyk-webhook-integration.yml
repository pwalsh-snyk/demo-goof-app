name: Snyk Webhook Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
  SNYK_ORG_ID: ${{ secrets.SNYK_ORG_ID }}

jobs:
  snyk-webhook-integration:
    runs-on: ubuntu-latest
    name: Snyk Scan with Webhook Integration

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Snyk CLI
      run: npm install -g snyk

    - name: Authenticate with Snyk
      run: snyk auth ${{ secrets.SNYK_TOKEN }}

    - name: Snyk Monitor (Open Source - Triggers Webhook)
      id: snyk-monitor
      run: |
        OUTPUT=$(snyk monitor \
          --org=${{ secrets.SNYK_ORG_ID }} \
          --project-name="goof-app-${{ github.event_name == 'pull_request' && 'pr' || 'main' }}" \
          --target-name="github-actions" \
          --target-reference="${{ github.ref_name }}" \
          --severity-threshold=medium 2>&1) || true
        echo "$OUTPUT"

        PROJECT_URL=$(echo "$OUTPUT" | grep -o 'https://app.snyk.io[^ ]*project/[^/ ]*' | head -1 || echo "")
        if [ -n "$PROJECT_URL" ]; then
          PROJECT_ID=$(echo "$PROJECT_URL" | grep -o 'project/[^/]*' | cut -d'/' -f2 || echo "")
          echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
          echo "project_url=$PROJECT_URL" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true

    - name: Snyk Code Test (SAST - Triggers Webhook)
      id: snyk-code
      run: |
        snyk code test \
          --org=${{ secrets.SNYK_ORG_ID }} \
          --report \
          --project-name="goof-app-code-${{ github.event_name == 'pull_request' && 'pr' || 'main' }}" \
          --target-name="github-actions" \
          --target-reference="${{ github.ref_name }}" \
          --severity-threshold=medium > snyk-code-output.txt 2>&1 || true

        PROJECT_URL=$(grep -o 'https://app.snyk.io[^ ]*' snyk-code-output.txt | head -1 || echo "")
        echo "project_url=$PROJECT_URL" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: Fetch All Issues and Create Work Items
      run: |
        echo "Fetching ALL issues from Snyk projects..."

        sudo apt-get update -qq && sudo apt-get install -y jq curl

        ORG_ID="${{ secrets.SNYK_ORG_ID }}"
        SNYK_TOKEN="${{ secrets.SNYK_TOKEN }}"
        API_BASE="https://api.snyk.io/v1"

        echo "Fetching all projects..."
        ALL_PROJECTS=$(curl -s -X GET \
          "${API_BASE}/org/${ORG_ID}/projects" \
          -H "Authorization: bearer ${SNYK_TOKEN}" \
          -H "Content-Type: application/json")

        echo "Raw ALL_PROJECTS response:"
        echo "$ALL_PROJECTS"

        if ! echo "$ALL_PROJECTS" | jq -e .projects > /dev/null; then
          echo "ERROR: Unable to parse .projects from Snyk API response"
          exit 1
        fi

        TOTAL_PROJECTS=$(echo "$ALL_PROJECTS" | jq -r '.projects | length // 0')
        echo "Found $TOTAL_PROJECTS total projects in org"

        echo "Sample projects:"
        echo "$ALL_PROJECTS" | jq -r '.projects[0:5]? | .[] | "  - \(.name) (type: \(.type), id: \(.id))"' || echo "  (could not parse projects)"

        PROJECTS=$(echo "$ALL_PROJECTS" | jq -r '.projects[]? | select(
          (.name | ascii_downcase | contains("goof")) or 
          (.name | contains("Snyk_Boards_Testing")) or
          (.name | contains("demo"))
        ) | {id: .id, name: .name, type: .type}')

        if [ -z "$PROJECTS" ] || [ "$PROJECTS" == "null" ]; then
          echo "No matching projects found. Using ALL projects (first 5) as fallback..."
          PROJECTS=$(echo "$ALL_PROJECTS" | jq -r '.projects[0:5]? | .[] | {id: .id, name: .name, type: .type}')
          if [ -z "$PROJECTS" ] || [ "$PROJECTS" == "null" ]; then
            echo "ERROR: No projects found in org at all"
            exit 1
          fi
        fi

        PROJECT_COUNT=$(echo "$PROJECTS" | jq -s 'length')
        echo "Processing $PROJECT_COUNT project(s)"

        echo "$PROJECTS" | jq -c '.' | while read -r project; do
          PROJECT_ID=$(echo "$project" | jq -r '.id')
          PROJECT_NAME=$(echo "$project" | jq -r '.name')
          PROJECT_TYPE=$(echo "$project" | jq -r '.type')

          echo "Processing project: $PROJECT_NAME (ID: $PROJECT_ID, Type: $PROJECT_TYPE)"

          ISSUES=$(curl -s -X POST \
            "${API_BASE}/org/${ORG_ID}/project/${PROJECT_ID}/issues" \
            -H "Authorization: bearer ${SNYK_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{
              "filters": {
                "severities": ["critical", "high", "medium"],
                "types": ["vuln", "license", "code"]
              }
            }' | jq -r '.issues[]? // empty')

          if [ -z "$ISSUES" ] || [ "$ISSUES" == "null" ]; then
            echo "No issues found for project $PROJECT_NAME"
            continue
          fi

          ISSUE_COUNT=$(echo "$ISSUES" | jq -s 'length')
          echo "Found $ISSUE_COUNT issues for $PROJECT_NAME"

          FORMATTED_ISSUES=$(echo "$ISSUES" | jq -s 'map({
            id: .id,
            issueData: {
              id: .id,
              title: (.title // .issueData.title // "Security Issue"),
              severity: (.severity // .issueData.severity // "medium" | ascii_downcase),
              description: (.description // .issueData.description // "Security vulnerability detected"),
              type: (.type // .issueData.type // "vuln"),
              packageName: (.package // .pkgName // .packageName // "unknown"),
              packageManager: (.packageManager // "npm"),
              url: (.url // .issueData.url // "https://app.snyk.io"),
              identifiers: (.identifiers // .issueData.identifiers // {})
            },
            introducedDate: (now | todateiso8601),
            priority: {
              score: 500,
              factors: []
            }
          })')

          PAYLOAD=$(jq -n \
            --arg org_id "$ORG_ID" \
            --arg org_name "Integration_Testing" \
            --arg project_id "$PROJECT_ID" \
            --arg project_name "$PROJECT_NAME" \
            --arg project_type "$PROJECT_TYPE" \
            --argjson issues "$FORMATTED_ISSUES" \
            '{
              project: {
                id: $project_id,
                name: $project_name,
                browseUrl: "https://app.snyk.io/org/integration_testing/project/\($project_id)",
                type: $project_type,
                source: "cli"
              },
              org: {
                id: $org_id,
                name: $org_name,
                slug: "integration_testing",
                group: null
              },
              newIssues: $issues,
              removedIssues: [],
              timestamp: (now | todateiso8601)
            }')

          AZURE_FUNCTION_CODE="${{ secrets.AZURE_FUNCTION_CODE }}"
          AZURE_FUNCTION_URL="https://snyk-webhook-68258.azurewebsites.net/api/snykwebhookfunction?code=${AZURE_FUNCTION_CODE}"

          echo "Sending $ISSUE_COUNT issues from $PROJECT_NAME to Azure Function..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "$AZURE_FUNCTION_URL" \
            -H "Content-Type: application/json" \
            -H "X-Snyk-Event: project_snapshot" \
            -H "X-Snyk-Timestamp: $(date -u +%Y-%m-%dT%H:%M:%S.000Z)" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "✅ Successfully sent $ISSUE_COUNT issues from $PROJECT_NAME"
            echo "Response: $BODY"
          else
            echo "⚠️ HTTP $HTTP_CODE response: $BODY"
          fi
        done

        echo "✅ Finished processing all projects"
      continue-on-error: true

    - name: Workflow Summary
      if: always()
      run: |
        echo "## Snyk Scan Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ Snyk monitoring completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Webhook Integration" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All issues (new and existing) have been sent to Azure Function" >> $GITHUB_STEP_SUMMARY
        echo "1. Work items created in Azure DevOps Boards" >> $GITHUB_STEP_SUMMARY
        echo "2. Check: https://dev.azure.com/pr352312/Snyk_Boards_Testing/_boards/board/t/Snyk%20Boards%20Testing/Issues" >> $GITHUB_STEP_SUMMARY
